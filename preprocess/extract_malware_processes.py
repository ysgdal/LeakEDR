#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import os
from pathlib import Path
from typing import List, Dict

# EDR process name list
EDR_PROCESSES = [
    "NisSrv.exe",
    "MsMpEng.exe",
    "SecurityHealthService.exe",
    "SecurityHealthSystray.exe"
]

# Falcon EDR process name list
# EDR_PROCESSES = [
#     "CSFalconService.exe",
#     "CsSystemTray_7.15.18514.0.exe",
#     "CSFalconContainer.exe"
# ]

# Kaspersky EDR process name list
# EDR_PROCESSES = [
#     "avp.exe",
#     "avpui.exe"
# ]


def extract_process_name_from_path(process_path: str) -> str:
    """
    Extract process name from a full process path.

    Examples:
        \\Device\\HarddiskVolume2\\Windows\\System32\\dwm.exe -> dwm.exe
        C:\\Users\\iie\\Desktop\\virussign.com_xxx.exe -> virussign.com_xxx.exe
    """
    if not process_path:
        return ""

    # Support both '\' and '/'
    process_path = process_path.replace("/", "\\")

    if "\\" in process_path:
        return process_path.split("\\")[-1]
    else:
        return process_path


def extract_malware_name_from_filename(log_filename: str) -> str:
    """
    Extract malware sample process name from the log filename.

    Example:
        virussign.com_efbe5b1875fa8f76e4a986b5915b8060.log
        -> virussign.com_efbe5b1875fa8f76e4a986b5915b8060.exe
    """
    # Remove .log suffix
    name = log_filename.replace(".log", "")
    # Add .exe suffix
    return f"{name}.exe"


def process_log_file(log_file_path: str, target_processes: List[str]) -> List[Dict]:
    """
    Process a single log file and extract records of target processes.

    Args:
        log_file_path: Path to the log file
        target_processes: List of target processes (EDR processes + malware process)

    Returns:
        A list of extracted records
    """
    extracted_records = []
    total_count = 0
    skipped_count = 0

    print(f"  Processing: {os.path.basename(log_file_path)}")

    with open(log_file_path, 'r', encoding='utf-8') as f:
        for line in f:
            total_count += 1

            # Show progress
            if total_count % 50000 == 0:
                print(f"    Processed {total_count} records, extracted {len(extracted_records)} records...")

            try:
                # Parse JSON
                data = json.loads(line.strip())

                # Skip records with Plugin='sysret'
                plugin = data.get('Plugin', '')
                if plugin == 'sysret':
                    skipped_count += 1
                    continue

                # Extract process name
                process_path = data.get('ProcessName', '')
                process_name = extract_process_name_from_path(process_path)

                # Check if it is a target process
                if process_name in target_processes:
                    # Keep original data and add extracted process name
                    record = data.copy()
                    record['ExtractedProcessName'] = process_name
                    extracted_records.append(record)

            except json.JSONDecodeError as e:
                print(f"    Warning: JSON parsing error at line {total_count}: {e}")
                continue
            except Exception as e:
                print(f"    Warning: Error processing line {total_count}: {e}")
                continue

    print(
        f"    Completed: total={total_count}, "
        f"extracted={len(extracted_records)}, "
        f"skipped(sysret)={skipped_count}"
    )

    return extracted_records


def sort_by_timestamp(records: List[Dict]) -> List[Dict]:
    """
    Sort records by timestamp.
    """
    return sorted(records, key=lambda x: float(x.get('TimeStamp', 0)))


def add_global_id(records: List[Dict]) -> List[Dict]:
    """
    Add a global ID to each record (starting from 1).
    """
    for idx, record in enumerate(records, start=1):
        record['GlobalID'] = idx
    return records


def process_stimulated_directory(input_dir: str, output_dir: str):
    """
    Process all log files under the stimulated directory.

    Args:
        input_dir: Input directory (stimulated)
        output_dir: Output directory (stimulated/processed)
    """
    input_path = Path(input_dir)
    output_path = Path(output_dir)

    # Create output directory if not exists
    output_path.mkdir(parents=True, exist_ok=True)

    # Get all .log files
    log_files = list(input_path.glob("*.log"))

    if not log_files:
        print(f"Error: No .log files found in {input_dir}")
        return

    print("=" * 60)
    print("Malware Sample Process Extraction Tool")
    print("=" * 60)
    print(f"Input directory:  {input_path.absolute()}")
    print(f"Output directory: {output_path.absolute()}")
    print(f"Found {len(log_files)} log files")
    print("-" * 60)

    # Statistics
    total_stats = {
        'files_processed': 0,
        'total_records': 0,
        'total_extracted': 0
    }

    # Process each log file
    for log_file in log_files:
        print(f"\nProcessing file: {log_file.name}")

        # Extract malware process name from filename
        malware_process = extract_malware_name_from_filename(log_file.name)

        # Target processes = EDR processes + malware process
        target_processes = EDR_PROCESSES + [malware_process]

        print(f"  Target processes:")
        print(f"    EDR: {', '.join(EDR_PROCESSES)}")
        print(f"    Malware sample: {malware_process}")

        # Extract records
        records = process_log_file(str(log_file), target_processes)

        if not records:
            print(f"  Warning: No records extracted")
            continue

        # Sort by timestamp
        print(f"  Sorting by timestamp...")
        records = sort_by_timestamp(records)

        # Add global ID
        print(f"  Adding global IDs...")
        records = add_global_id(records)

        # Output filename (same name, .jsonl extension)
        output_file = output_path / log_file.name.replace('.log', '.jsonl')

        # Write output file
        print(f"  Writing file: {output_file.name}")
        try:
            with open(output_file, 'w', encoding='utf-8') as f:
                for record in records:
                    f.write(json.dumps(record, ensure_ascii=False) + '\n')
        except Exception as e:
            print(f"  ✗ Write failed: {e}")
            continue

        # Count per process
        process_counts = {}
        for record in records:
            proc_name = record.get('ExtractedProcessName', 'unknown')
            process_counts[proc_name] = process_counts.get(proc_name, 0) + 1

        print(f"\n  Process statistics:")
        for proc, count in sorted(process_counts.items(), key=lambda x: -x[1]):
            print(f"    {proc}: {count} records")

        # Update total statistics
        total_stats['files_processed'] += 1
        total_stats['total_extracted'] += len(records)

        print(f"  ✓ Completed: extracted {len(records)} records")

        # Delete source file
        try:
            log_file.unlink()
            print(f"  ✓ Source file deleted: {log_file.name}")
        except Exception as e:
            print(f"  ✗ Failed to delete source file: {e}")

    # Print summary
    print("\n" + "=" * 60)
    print("Processing completed!")
    print("=" * 60)
    print(f"Files processed: {total_stats['files_processed']}")
    print(f"Total records extracted: {total_stats['total_extracted']}")
    print(f"Output directory: {output_path.absolute()}")
    print("=" * 60)


def main():
    # Default paths
    input_dir = "../data/stimulated"
    output_dir = "../data/stimulated/processed"

    print("⚠️  Warning: After processing, source .log files will be deleted automatically to save disk space.")
    print("-" * 60)

    # Execute processing
    process_stimulated_directory(input_dir, output_dir)

    print("\n[SUCCESS] Malware sample process data has been successfully extracted!")
    print("         Source .log files have been removed.")


if __name__ == "__main__":
    main()
